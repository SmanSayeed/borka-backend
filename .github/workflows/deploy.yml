name: Deploy Borka React Inertia Laravel API APP

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy via SSH (git pull & build)
        id: deploy
        uses: appleboy/ssh-action@v1.2.2
        continue-on-error: true
        with:
          host: "81.17.102.39"
          username: 'root'
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "Starting deployment..."
            echo "Moving to project directory-> /var/www/borka.metroboys.com"
            cd "/var/www/borka.metroboys.com"
            git stash
            git clean -f
            echo "Pulling latest changes from main branch..."
            git pull origin main

            if git diff --name-only HEAD@{1} HEAD | grep -qE 'pnpm(-lock)?\.json'; then
              echo "package.json or pnpm-lock.json has changed. Running pnpm install..."
              pnpm install || {echo "pnpm install failed"; exit 1;}
            else
              echo "package.json unchanged. skipping pnpm install..."
            fi

            echo "Running pnpm build to build assets..."
            pnpm build || {echo "pnpm build failed"; exit 1;}

            if git diff --name-only HEAD@{1} HEAD | grep -qE 'composer\.(json|lock)'; then
              echo "composer.json or composer.lock changed. Running composer install..."
              composer install || { echo "composer install failed"; exit 1; }
            else
              echo "composer.json and composer.lock unchanged. Skipping composer install."
            fi

            if git diff --name-only HEAD@{1} HEAD | grep -q '^database/migrations/'; then
              echo "Migration files changed. Running php artisan migrate..."
              php artisan migrate || { echo "migration failed"; exit 1; }
            else
              echo "No migration changes detected. Skipping php artisan migrate."
            fi

            echo "Clearing Laravel caches..."
            php artisan config:clear || { echo "config:clear failed"; exit 1; }
            php artisan route:clear || { echo "route:clear failed"; exit 1; }
            php artisan cache:clear || { echo "cache:clear failed"; exit 1; }
            php artisan view:clear || { echo "view:clear failed"; exit 1; }

            echo "Deployment completed successfully!"
            
      - name: Get commit details
        id: commit
        run: |
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_url=https://github.com/$GITHUB_REPOSITORY/commit/$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

          # Multiline-safe output for commit_message with proper escaping
          {
            echo 'commit_message<<EOF'
            git log -1 --pretty=%B | jq -Rs .
            echo EOF
          } >> $GITHUB_OUTPUT
