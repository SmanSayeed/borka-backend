name: ðŸš€ Deploy Borka React Inertia Laravel API APP

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy via SSH (force sync + build + migrate)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: "81.17.102.39"
          username: "root"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."
            cd /var/www/borka.metroboys.com

            echo "âœ… Marking safe directory..."
            git config --global --add safe.directory /var/www/borka.metroboys.com

            echo "ðŸ§¹ Cleaning working directory..."
            git pull origin main

            echo "ðŸ“¦ Checking dependencies..."
            export NVM_DIR="$HOME/.nvm"
            export PATH="$NVM_DIR/versions/node/v22.21.0/bin:$HOME/.local/share/pnpm:$PATH"
            pnpm --version
            echo "Removing node_modules and installing dependencies..."
            rm -rf node_modules
            pnpm install || { echo "pnpm install failed"; exit 1; }

            echo "âš™ï¸ Building frontend assets..."
            pnpm build || { echo "pnpm build failed"; exit 1; }

            if git diff --name-only HEAD@{1} HEAD | grep -qE 'composer\.(json|lock)'; then
              echo "composer.json/lock changed â€” running composer install..."
              composer install --no-dev --optimize-autoloader || { echo "composer install failed"; exit 1; }
            else
              echo "No composer changes â€” skipping composer install."
            fi

            if git diff --name-only HEAD@{1} HEAD | grep -q '^database/migrations/'; then
              echo "ðŸ§± Migrations changed â€” running migrations..."
              php artisan migrate --force || { echo "Migration failed"; exit 1; }
            else
              echo "No migration changes detected â€” skipping migrations."
            fi

            echo "ðŸ§½ Clearing Laravel caches..."
            php artisan optimize:clear || true
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true

            echo "âœ… Deployment completed successfully!"

      - name: Get commit details
        id: commit
        run: |
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "commit_url=https://github.com/$GITHUB_REPOSITORY/commit/$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          {
            echo 'commit_message<<EOF'
            git log -1 --pretty=%B
            echo EOF
          } >> $GITHUB_OUTPUT
